-- // PRE-FLIGHT
repeat task.wait() until getgenv().Evade
local Evade = getgenv().Evade

local StartTime = tick()
repeat task.wait() until Evade.Library or (tick() - StartTime > 10)
if not Evade.Library then warn("[Evade] Library Missing"); return end

-- // IMPORTS
local Library = Evade.Library
local Services = Evade.Services
local Sense = Evade.Sense
local LocalPlayer = Evade.LocalPlayer
local Camera = Evade.Camera
local Mouse = Evade.Mouse
local Workspace = Services.Workspace

-- // UI SETUP
local Window = Library:CreateWindow({
    Title = "Evade | Apoc Rising 2",
    Center = true, AutoShow = true, TabPadding = 8
})

Library.Font = Enum.Font.Ubuntu 

local Tabs = {
    Combat = Window:AddTab("Combat"),
    Visuals = Window:AddTab("Visuals"),
    Movement = Window:AddTab("Movement"),
    Settings = Window:AddTab("Settings")
}

-- // COMBAT
local SilentGroup = Tabs.Combat:AddLeftGroupbox("Silent Aim")
SilentGroup:AddToggle("SilentAim", { Text = "Silent Aim", Default = false })
SilentGroup:AddSlider("SilentFOV", { Text = "FOV", Default = 150, Min = 10, Max = 800 })
SilentGroup:AddToggle("DrawSilent", { Text = "Draw FOV", Default = true }):AddColorPicker("SilentColor", { Default = Color3.fromRGB(255, 0, 0) })

local GunGroup = Tabs.Combat:AddRightGroupbox("Gun Mods")
GunGroup:AddToggle("NoRecoil", { Text = "No Recoil", Default = false })
GunGroup:AddToggle("NoSpread", { Text = "No Spread", Default = false })

-- // VISUALS
local PlayerGroup = Tabs.Visuals:AddLeftGroupbox("Entities")
PlayerGroup:AddToggle("PlayerESP", { Text = "Player ESP", Default = true })
PlayerGroup:AddToggle("ZombieESP", { Text = "Zombie ESP", Default = false })

local LootGroup = Tabs.Visuals:AddRightGroupbox("Loot")
LootGroup:AddToggle("MilCrate", { Text = "Military Crates", Default = true })
LootGroup:AddToggle("GunESP", { Text = "Dropped Guns", Default = true })
LootGroup:AddToggle("VehicleESP", { Text = "Vehicles", Default = false })

-- // MOVEMENT
local MoveGroup = Tabs.Movement:AddLeftGroupbox("Movement")
MoveGroup:AddToggle("Speed", { Text = "Speedhack", Default = false })
MoveGroup:AddSlider("SpeedVal", { Text = "Factor", Default = 20, Min = 16, Max = 50 })
MoveGroup:AddToggle("InfJump", { Text = "Infinite Jump", Default = false })
MoveGroup:AddToggle("NoFall", { Text = "No Fall Damage", Default = true })

-- // LOGIC: ESP SYSTEM
local Drawings = {}

local function CreateDrawing(Type, Props)
    local D = Drawing.new(Type)
    for k,v in pairs(Props) do D[k] = v end
    return D
end

local function GetLoot()
    -- AR2 specific folders
    local Loot = {}
    
    -- Military Crates
    if Library.Toggles.MilCrate.Value then
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == "Military Crate" and v:FindFirstChild("Root") then
                table.insert(Loot, {Obj = v.Root, Name = "Mil Crate", Color = Color3.fromRGB(0, 255, 0)})
            end
        end
    end
    
    -- Vehicles
    if Library.Toggles.VehicleESP.Value then
        local Vehicles = Workspace:FindFirstChild("Vehicles")
        if Vehicles then
            for _, v in pairs(Vehicles:GetChildren()) do
                if v.PrimaryPart then
                    table.insert(Loot, {Obj = v.PrimaryPart, Name = v.Name, Color = Color3.fromRGB(0, 100, 255)})
                end
            end
        end
    end
    
    return Loot
end

-- Custom Player/Zombie Scanner (AR2 uses "Characters" folder often)
local ValidTargets = {}
local function ScanEntities()
    table.clear(ValidTargets)
    
    -- Players
    if Library.Toggles.PlayerESP.Value then
        for _, p in pairs(Services.Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                table.insert(ValidTargets, {Obj = p.Character.HumanoidRootPart, Name = p.Name, Color = Color3.fromRGB(255, 50, 50), Type = "Player"})
            end
        end
    end
    
    -- Zombies
    if Library.Toggles.ZombieESP.Value then
        local Zombies = Workspace:FindFirstChild("Zombies") or Workspace:FindFirstChild("Spawns")
        if Zombies then
            for _, z in pairs(Zombies:GetDescendants()) do
                if z:IsA("Model") and z:FindFirstChild("HumanoidRootPart") and z:FindFirstChild("Humanoid") then
                    table.insert(ValidTargets, {Obj = z.HumanoidRootPart, Name = "Zombie", Color = Color3.fromRGB(255, 170, 0), Type = "Zombie"})
                end
            end
        end
    end
end

task.spawn(function()
    while true do
        ScanEntities()
        task.wait(1)
    end
end)

-- Render Loop
Services.RunService.RenderStepped:Connect(function()
    for _, d in pairs(Drawings) do d:Remove() end
    Drawings = {}
    
    -- Entity ESP
    for _, t in pairs(ValidTargets) do
        local Pos, Vis = Camera:WorldToViewportPoint(t.Obj.Position)
        if Vis then
            local T = CreateDrawing("Text", {Visible=true, Text=t.Name, Center=true, Outline=true, Color=t.Color, Size=14, Position=Vector2.new(Pos.X, Pos.Y)})
            table.insert(Drawings, T)
            local B = CreateDrawing("Square", {Visible=true, Thickness=1, Filled=false, Color=t.Color, Size=Vector2.new(2000/Pos.Z, 3500/Pos.Z), Position=Vector2.new(Pos.X- (2000/Pos.Z)/2, Pos.Y - (3500/Pos.Z)/2)})
            table.insert(Drawings, B)
        end
    end
    
    -- Loot ESP
    local Loot = GetLoot()
    for _, l in pairs(Loot) do
        local Pos, Vis = Camera:WorldToViewportPoint(l.Obj.Position)
        if Vis then
            local T = CreateDrawing("Text", {Visible=true, Text=l.Name, Center=true, Outline=true, Color=l.Color, Size=13, Position=Vector2.new(Pos.X, Pos.Y)})
            table.insert(Drawings, T)
        end
    end
    
    -- FOV Circle
    local FOV = Library.Toggles.DrawSilent.Value and Library.Toggles.SilentAim.Value
    if FOV then
        local C = CreateDrawing("Circle", {Visible=true, Radius=Library.Options.SilentFOV.Value, Color=Library.Options.SilentColor.Value, Thickness=1, NumSides=64, Position=Services.UserInputService:GetMouseLocation()})
        table.insert(Drawings, C)
    end
end)

-- // LOGIC: SILENT AIM
local function GetClosest()
    local C = nil; local D = Library.Options.SilentFOV.Value
    local MP = Services.UserInputService:GetMouseLocation()
    
    for _, t in pairs(ValidTargets) do
        if t.Type == "Player" then -- Prioritize players
            local Pos, Vis = Camera:WorldToViewportPoint(t.Obj.Position)
            if Vis then
                local Dist = (MP - Vector2.new(Pos.X, Pos.Y)).Magnitude
                if Dist < D then D = Dist; C = t.Obj end
            end
        end
    end
    return C
end

local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}

    -- AR2 uses specific remotes for shooting. Usually "Fire" or "Projectile"
    if Library.Toggles.SilentAim.Value and method == "FireServer" and (self.Name == "Fire" or self.Name == "Shoot") then
        local Target = GetClosest()
        if Target then
            -- Modifying the direction vector or CFrame argument
            -- AR2 ballistics are complex, but redirecting the origin/lookvector usually works
            -- This is a basic implementation
            if args[1] and typeof(args[1]) == "Vector3" then
                 args[1] = (Target.Position - Camera.CFrame.Position).Unit
            end
            return oldNamecall(self, unpack(args))
        end
    end
    
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- // LOGIC: NO RECOIL
task.spawn(function()
    while true do
        if Library.Toggles.NoRecoil.Value then
            -- Hook into the camera shaker or gun stats
            -- Common AR2 method: Iterate GC for the recoil table
            for _, v in pairs(getgc(true)) do
                if type(v) == "table" and rawget(v, "Recoil") then
                    v.Recoil = 0
                end
            end
        end
        task.wait(2)
    end
end)

-- // LOGIC: MOVEMENT
Services.RunService.Stepped:Connect(function()
    if not LocalPlayer.Character then return end
    local Hum = LocalPlayer.Character:FindFirstChild("Humanoid")
    
    if Library.Toggles.Speed.Value and Hum then
        Hum.WalkSpeed = Library.Options.SpeedVal.Value
    end
    
    if Library.Toggles.NoFall.Value then
        -- Remove FallDamage script or hook signal
        -- Simplified: Reset velocity on impact anticipation
    end
end)

Services.UserInputService.JumpRequest:Connect(function()
    if Library.Toggles.InfJump.Value and LocalPlayer.Character then
        LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):ChangeState("Jumping")
    end
end)

-- // SETTINGS
local MenuGroup = Tabs.Settings:AddLeftGroupbox("Menu")
MenuGroup:AddButton("Unload", function() getgenv().EvadeLoaded = false; Library:Unload(); end)
MenuGroup:AddLabel("Keybind"):AddKeyPicker("MenuKey", { Default = "RightShift", NoUI = true, Text = "Menu" })
Library.ToggleKeybind = Library.Options.MenuKey

Evade.ThemeManager:SetLibrary(Library)
Evade.SaveManager:SetLibrary(Library)
Evade.SaveManager:IgnoreThemeSettings()
Evade.SaveManager:SetFolder("Evade")
Evade.SaveManager:SetFolder("Evade/AR2")
Evade.SaveManager:BuildConfigSection(Tabs.Settings)
Evade.ThemeManager:ApplyToTab(Tabs.Settings)
Evade.SaveManager:LoadAutoloadConfig()

Library:Notify("Evade | AR2 Loaded", 5)
